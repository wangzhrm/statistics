<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Team Manager – Drag & Save to LeanCloud</title>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f7fa;
        margin: 20px;
        color: #333;
    }
    h1 {
        text-align: center;
        color: #2c3e50;
    }
    .subtitle {
        text-align: center;
        color: #7f8c8d;
        margin-bottom: 20px;
    }
    .container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        max-width: 1600px;
        margin: 0 auto;
    }
    .groups {
        flex: 3;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }
    .group {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        border: 2px solid #3498db;
    }
    .group h3 {
        margin: 0 0 12px;
        text-align: center;
        color: #2980b9;
    }
    .slot {
        min-height: 60px;
        padding: 10px;
        margin: 8px 0;
        border-radius: 8px;
        text-align: center;
        border: 2px dashed #bdc3c7;
        background: #f8f9fa;
    }
    .person {
        background: #3498db;
        color: white;
        padding: 8px 14px;
        margin: 4px;
        border-radius: 6px;
        display: inline-block;
        cursor: move;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .empty {
        color: #95a5a6;
        font-style: italic;
        line-height: 60px;
    }
    .pool {
        flex: 1;
        min-width: 280px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        align-self: flex-start;
    }
    .pool h2 {
        margin-top: 0;
        color: #e74c3c;
        text-align: center;
    }
    #pool-area {
        min-height: 500px;
        border: 3px dashed #95a5a6;
        border-radius: 10px;
        padding: 15px;
        background: #ecf0f1;
    }
    .drag-over {
        background: #d5f5e3 !important;
        border-color: #27ae60 !important;
    }
    #save-btn {
        display: block;
        margin: 30px auto;
        padding: 14px 28px;
        font-size: 1.1em;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
    }
    #save-btn:hover {
        background: #219653;
    }
    #status {
        text-align: center;
        margin-top: 10px;
        min-height: 24px;
        font-weight: bold;
    }
</style>
</head>
<body>

<h1>Assign 47 Students to 24 Teams</h1>
<p class="subtitle">Drag students between teams and the pool. Click “Save to LeanCloud” to persist.</p>

<div class="container">
    <div class="groups" id="groups-area"></div>

    <div class="pool">
        <h2>Available Students</h2>
        <div id="pool-area"></div>
    </div>
</div>

<button id="save-btn">Save to LeanCloud</button>
<div id="status"></div>

<script>
// ==================== 1. Initialize LeanCloud ====================
AV.init({
    appId: "IgXd8B4cfA1N6dcnGY8ipZcD-gzGzoHsz",
    appKey: "o7JdYuMhgcGMETm83Y1dq0KZ"
});

// ==================== 2. Student List ====================
const allStudents = [
    "田雪", "胡雅涵", "范思颖", "刘小潞", "李欣霖", "李唯怡", "何雨熹", "罗熙琳",
    "吴可涵", "何艾霖", "吴莹莹", "于静雯", "彭桢茗", "柯柏宇", "赵彦杰", "丁泊文",
    "肖喃允", "张钰翎", "唐思诺", "余宜莲", "郑行", "陶雨果", "李虹颖", "何雨睿",
    "冯琳娟", "李海韵", "金志晖", "柯柏廷", "周朕宇", "唐晞尧", "李书行", "陈安达",
    "任柯嘉", "刘阳睿", "李志浩", "陈怡诺（男）", "王铄", "冯嘉熙", "许欣仪", "李沂蔓",
    "方小灿", "罗钰淇", "刘子琦", "陈怡诺（女）", "吴郑阳", "易星辰", "殷小丁"
];

let draggedElement = null;

// ==================== 3. Render Initial UI ====================
function renderGroups() {
    const groupsArea = document.getElementById('groups-area');
    groupsArea.innerHTML = '';
    for (let i = 1; i <= 24; i++) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        groupDiv.innerHTML = `
            <h3>Group ${i}</h3>
            <div class="slot" ondragover="allowDrop(event)" ondrop="drop(event)">
                <span class="empty">Empty</span>
            </div>
            <div class="slot" ondragover="allowDrop(event)" ondrop="drop(event)">
                <span class="empty">Empty</span>
            </div>
        `;
        groupsArea.appendChild(groupDiv);
    }
}

function renderPool(students) {
    const poolArea = document.getElementById('pool-area');
    poolArea.innerHTML = '';
    students.forEach(name => {
        const el = document.createElement('span');
        el.className = 'person';
        el.draggable = true;
        el.textContent = name;
        el.ondragstart = drag;
        poolArea.appendChild(el);
    });
}

// ==================== 4. Drag & Drop Logic ====================
function allowDrop(e) {
    e.preventDefault();
    const target = e.target.closest('.slot');
    if (target) target.classList.add('drag-over');
}

function drag(e) {
    const el = e.target;
    if (!el.classList.contains('person')) return;
    draggedElement = el;
    e.dataTransfer.setData('text/plain', el.textContent);
}

function drop(e) {
    e.preventDefault();
    const slot = e.target.closest('.slot');
    if (!slot || !draggedElement) return;

    slot.classList.remove('drag-over');
    draggedElement.remove();

    slot.innerHTML = '';
    draggedElement.ondragstart = drag;
    slot.appendChild(draggedElement);
}

// Allow dropping into pool
const poolArea = document.getElementById('pool-area');
poolArea.ondragover = function(e) {
    e.preventDefault();
    this.classList.add('drag-over');
};
poolArea.ondrop = function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
    if (draggedElement) {
        const name = draggedElement.textContent;
        draggedElement.remove();
        const newPerson = document.createElement('span');
        newPerson.className = 'person';
        newPerson.draggable = true;
        newPerson.textContent = name;
        newPerson.ondragstart = drag;
        this.appendChild(newPerson);
        draggedElement = null;
    }
};

document.addEventListener('dragend', () => {
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
});

// ==================== 5. Save to LeanCloud ====================
async function saveToLeanCloud() {
    const statusEl = document.getElementById('status');
    statusEl.textContent = "Saving...";
    statusEl.style.color = "#2980b9";

    try {
        // Delete all existing Team records
        const query = new AV.Query('Team');
        const existing = await query.limit(1000).find();
        if (existing.length > 0) {
            await AV.Object.destroyAll(existing);
        }

        // Collect current assignments
        const assignments = [];
        document.querySelectorAll('.group').forEach((groupEl, idx) => {
            const slots = groupEl.querySelectorAll('.slot');
            const m1 = slots[0].textContent.trim();
            const m2 = slots[1].textContent.trim();
            const groupNum = idx + 1;
            if (m1 !== 'Empty') assignments.push({ groupNumber: groupNum, studentName: m1 });
            if (m2 !== 'Empty') assignments.push({ groupNumber: groupNum, studentName: m2 });
        });

        // Save each assignment
        const Team = AV.Object.extend('Team');
        const promises = assignments.map(item => {
            const obj = new Team();
            obj.set('groupNumber', item.groupNumber);
            obj.set('studentName', item.studentName);
            return obj.save();
        });

        await Promise.all(promises);
        statusEl.textContent = "✅ Saved successfully!";
        statusEl.style.color = "#27ae60";
    } catch (error) {
        console.error("Save error:", error);
        statusEl.textContent = `❌ Save failed: ${error.message}`;
        statusEl.style.color = "#e74c3c";
    }
}

// ==================== 6. Load from LeanCloud ====================
async function loadFromLeanCloud() {
    try {
        const query = new AV.Query('Team');
        const results = await query.limit(1000).find();

        if (results.length === 0) {
            return; // Keep initial render
        }

        // Build group map
        const groupMap = {};
        for (let i = 1; i <= 24; i++) groupMap[i] = [];

        results.forEach(obj => {
            const g = obj.get('groupNumber');
            const s = obj.get('studentName');
            if (typeof g === 'number' && g >= 1 && g <= 24 && typeof s === 'string') {
                groupMap[g].push(s);
            }
        });

        // Re-render groups with data
        renderGroups();
        const groupEls = document.querySelectorAll('.group');
        groupEls.forEach((el, i) => {
            const gNum = i + 1;
            const members = groupMap[gNum];
            const slots = el.querySelectorAll('.slot');
            slots[0].innerHTML = members[0] ? `<span class="person" draggable="true" ondragstart="drag(event)">${members[0]}</span>` : '<span class="empty">Empty</span>';
            slots[1].innerHTML = members[1] ? `<span class="person" draggable="true" ondragstart="drag(event)">${members[1]}</span>` : '<span class="empty">Empty</span>';
        });

        // Update pool
        const used = new Set(Object.values(groupMap).flat());
        const poolStudents = allStudents.filter(name => !used.has(name));
        renderPool(poolStudents);

    } catch (error) {
        console.error("Load error:", error);
        // Keep default view
    }
}

// ==================== 7. Initialize ====================
document.getElementById('save-btn').addEventListener('click', saveToLeanCloud);

// Always show something immediately
renderGroups();
renderPool(allStudents);

// Then try to override with saved data
loadFromLeanCloud();
</script>
</body>
</html>