<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
  <script>
    AV.init({
      appId: "NvC4d9DG9SsuryBsCgkX7fpW-gzGzoHsz",
      appKey: "GOuT5So30SilOjB65cuFGQ4X",
      serverURL: "https://nvc4d9dg.lc-cn-n1-shared.com"
    });
  </script>
  <style>
    table { border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #999; padding: 6px 10px; }
    input, button { margin: 4px; padding: 4px; }
    .section { margin-top: 30px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <!-- Student Management -->
  <div class="section">
    <h2>Manage Students</h2>
    <input type="text" id="newStudentName" placeholder="New student name" />
    <button onclick="addStudent()">Add Student</button>

    <table id="studentTable">
      <thead><tr><th>Name</th><th>Actions</th></tr></thead>
      <tbody id="studentList"></tbody>
    </table>
  </div>

  <!-- Criteria Management -->
  <div class="section">
    <h2>Marking Criteria (Total must be 100)</h2>
    <div id="criteriaEditor"></div>
    <button onclick="saveCriteria()">Save Criteria</button>
    <p id="criteriaMessage" class="error"></p>
  </div>

  <!-- Results View -->
  <div class="section">
    <h2>Feedback Results</h2>
    <button onclick="loadResults()">Refresh Results</button>
    <table id="resultsTable">
      <thead><tr><th>Student</th><th>Received Scores</th><th>Average</th></tr></thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <script>
    let students = [];
    let criteria = [];

    // === STUDENTS ===
    async function loadStudents() {
      const query = new AV.Query('Student');
      const res = await query.find();
      students = res.map(s => ({ id: s.id, name: s.get('name') }));
      renderStudents();
    }

    function renderStudents() {
      const tbody = document.getElementById('studentList');
      tbody.innerHTML = '';
      students.forEach(s => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = s.name;
        const actions = row.insertCell(1);
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => deleteStudent(s.id);
        actions.appendChild(delBtn);
      });
    }

    async function addStudent() {
      const name = document.getElementById('newStudentName').value.trim();
      if (!name) return;
      const Student = AV.Object.extend('Student');
      const student = new Student();
      student.set('name', name);
      await student.save();
      document.getElementById('newStudentName').value = '';
      loadStudents();
    }

    async function deleteStudent(id) {
      const obj = AV.Object.createWithoutData('Student', id);
      await obj.destroy();
      loadStudents();
    }

    // === CRITERIA ===
    async function loadCriteria() {
      const query = new AV.Query('Criterion');
      const res = await query.find();
      criteria = res.map(c => ({
        id: c.id,
        title: c.get('title'),
        description: c.get('description'),
        maxScore: c.get('maxScore')
      }));
      renderCriteriaEditor();
    }

    function renderCriteriaEditor() {
      const container = document.getElementById('criteriaEditor');
      container.innerHTML = '';
      criteria.forEach((c, i) => {
        const div = document.createElement('div');
        div.innerHTML = `
          <input type="text" placeholder="Title" value="${c.title}" data-id="${c.id}" class="crit-title" />
          <input type="text" placeholder="Description" value="${c.description}" class="crit-desc" />
          <input type="number" placeholder="Max" value="${c.maxScore}" min="0" class="crit-max" />
          <button type="button" onclick="removeCriterion(${i})">Remove</button>
        `;
        container.appendChild(div);
      });
      const addBtn = document.createElement('button');
      addBtn.textContent = '+ Add Criterion';
      addBtn.onclick = addEmptyCriterion;
      container.appendChild(addBtn);
    }

    function addEmptyCriterion() {
      criteria.push({ id: null, title: '', description: '', maxScore: 0 });
      renderCriteriaEditor();
    }

    function removeCriterion(index) {
      criteria.splice(index, 1);
      renderCriteriaEditor();
    }

    async function saveCriteria() {
      const messageEl = document.getElementById('criteriaMessage');
      const inputs = document.querySelectorAll('#criteriaEditor input');
      const newCriteria = [];
      let totalMax = 0;

      for (let i = 0; i < criteria.length; i++) {
        const title = document.querySelectorAll('.crit-title')[i].value.trim();
        const desc = document.querySelectorAll('.crit-desc')[i].value.trim();
        const max = parseFloat(document.querySelectorAll('.crit-max')[i].value);
        if (!title || isNaN(max) || max <= 0) {
          messageEl.textContent = "All criteria must have valid title and max score.";
          return;
        }
        totalMax += max;
        newCriteria.push({ title, description: desc, maxScore: max, id: criteria[i].id });
      }

      if (Math.abs(totalMax - 100) > 0.01) {
        messageEl.textContent = `Total max score must be 100. Current: ${totalMax.toFixed(2)}`;
        return;
      }

      // Delete old criteria
      const oldQuery = new AV.Query('Criterion');
      const oldList = await oldQuery.find();
      if (oldList.length > 0) {
        await AV.Object.destroyAll(oldList);
      }

      // Save new ones
      const Criterion = AV.Object.extend('Criterion');
      const objects = newCriteria.map(c => {
        const obj = new Criterion();
        obj.set('title', c.title);
        obj.set('description', c.description);
        obj.set('maxScore', c.maxScore);
        return obj;
      });
      await AV.Object.saveAll(objects);
      messageEl.textContent = "Criteria saved!";
      messageEl.style.color = "green";
      loadCriteria();
    }

    // === RESULTS ===
    async function loadResults() {
      // Get all students
      const studentQuery = new AV.Query('Student');
      const studentObjs = await studentQuery.find();
      const studentMap = {};
      studentObjs.forEach(s => studentMap[s.id] = s.get('name'));

      // Get all feedbacks
      const fbQuery = new AV.Query('Feedback');
      fbQuery.include('targetStudent');
      const feedbacks = await fbQuery.find();

      // Group by student
      const scoreGroups = {};
      feedbacks.forEach(fb => {
        const sid = fb.get('targetStudent').id;
        if (!scoreGroups[sid]) scoreGroups[sid] = [];
        scoreGroups[sid].push(fb.get('total'));
      });

      // Render
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '';
      Object.keys(studentMap).forEach(sid => {
        const scores = scoreGroups[sid] || [];
        const avg = scores.length ? (scores.reduce((a,b)=>a+b)/scores.length).toFixed(2) : 'N/A';
        const row = tbody.insertRow();
        row.insertCell(0).textContent = studentMap[sid];
        row.insertCell(1).textContent = scores.join(', ');
        row.insertCell(2).textContent = avg;
      });
    }

    // Init
    (async () => {
      await loadStudents();
      await loadCriteria();
      await loadResults();
    })();
  </script>
</body>
</html>