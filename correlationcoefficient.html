<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Correlation Scatter Plot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #9ca3af; /* gray-400 */
            shape-rendering: crispEdges;
        }
        .axis text {
            fill: #4b5563; /* gray-600 */
            font-size: 12px;
        }
        .tick line {
            stroke: #e5e7eb; /* gray-200 */
            stroke-dasharray: 2,2;
        }
        /* Custom styles for range input */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db; /* gray-300 */
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Interactive Scatter Plot & Correlation</h1>
            <p class="text-gray-600 mt-2">Adjust the sliders to see how the slope and spread of data affect the correlation coefficient (r).</p>
        </div>

        <!-- Controls -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-center bg-gray-100 p-4 rounded-lg">
            <!-- Slope Control -->
            <div class="flex flex-col space-y-2">
                <label for="slope" class="font-medium text-gray-700">Slope Angle</label>
                <!-- This slider now controls the angle from ~-90 to ~+90 degrees -->
                <input type="range" id="slope" min="-1.55" max="1.55" step="0.01" value="0.46" class="w-full">
            </div>
            <!-- Width Control -->
            <div class="flex flex-col space-y-2">
                <label for="width" class="font-medium text-gray-700">Band Width (Spread)</label>
                <input type="range" id="width" min="0" max="100" step="1" value="30" class="w-full">
            </div>
            <!-- Correlation Display -->
            <div class="text-center bg-white p-4 rounded-lg shadow-inner">
                <h2 class="text-lg font-semibold text-gray-800">Correlation (r)</h2>
                <p id="correlation" class="text-3xl font-bold text-blue-600 mt-1">0.00</p>
            </div>
        </div>

        <!-- D3 Chart Container -->
        <div id="chart-container" class="w-full aspect-video bg-gray-50 rounded-lg border border-gray-200"></div>
    </div>

    <script>
        // --- Core Logic ---

        // 1. Setup D3 Chart Area
        const container = document.getElementById('chart-container');
        const margin = { top: 20, right: 20, bottom: 40, left: 40 };
        let width, height; // To be set dynamically

        const svg = d3.select("#chart-container")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");

        const chartGroup = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Scales and Axes
        const xScale = d3.scaleLinear().domain([0, 100]);
        const yScale = d3.scaleLinear().domain([0, 100]);
        const xAxis = d3.axisBottom(xScale);
        const yAxis = d3.axisLeft(yScale);

        const xAxisGroup = chartGroup.append("g")
            .attr("class", "axis x-axis");
        const yAxisGroup = chartGroup.append("g")
            .attr("class", "axis y-axis");

        // Gridlines
        const xGridlines = chartGroup.append("g").attr("class", "grid x-gridlines");
        const yGridlines = chartGroup.append("g").attr("class", "grid y-gridlines");

        // 2. Data Generation (REVISED LOGIC)
        const n = 150; // Number of data points
        const generateData = (angle, bandWidth) => {
            const data = [];
            const cx = 50; // center x
            const cy = 50; // center y
            const cosAngle = Math.cos(angle);
            const sinAngle = Math.sin(angle);

            for (let i = 0; i < n; i++) {
                // Generate a point along a central line defined by the angle
                // The line passes through (cx, cy). The distance along the line is randomized.
                const lineDist = (Math.random() - 0.5) * 140; // Approx. diagonal of the chart

                const x_perfect = cx + lineDist * cosAngle;
                const y_perfect = cy + lineDist * sinAngle;

                // Add random noise perpendicular to the central line
                const noiseDist = (Math.random() - 0.5) * bandWidth;

                let x = x_perfect - noiseDist * sinAngle;
                let y = y_perfect + noiseDist * cosAngle;

                // Clamp values to keep points within the visible chart area
                x = Math.max(0, Math.min(100, x));
                y = Math.max(0, Math.min(100, y));

                data.push({ x, y });
            }
            return data;
        };

        // 3. Correlation Calculation
        const calculateCorrelation = (data) => {
            const xMean = d3.mean(data, d => d.x);
            const yMean = d3.mean(data, d => d.y);

            let numerator = 0;
            let den_x = 0;
            let den_y = 0;

            for (let i = 0; i < n; i++) {
                const dx = data[i].x - xMean;
                const dy = data[i].y - yMean;
                numerator += dx * dy;
                den_x += dx * dx;
                den_y += dy * dy;
            }

            if (den_x === 0 || den_y === 0) return 0;

            return numerator / Math.sqrt(den_x * den_y);
        };

        // 4. Update Function (The heart of the interactivity)
        const updateChart = () => {
            // Get current slider values
            const angle = +document.getElementById("slope").value;
            const width = +document.getElementById("width").value;

            // Generate new data based on slider values
            const data = generateData(angle, width);

            // Calculate and display correlation
            const correlation = calculateCorrelation(data);
            document.getElementById("correlation").textContent = correlation.toFixed(2);

            // Bind data to circles
            const circles = chartGroup.selectAll("circle")
                .data(data);

            // Enter, update, and exit pattern for the points
            circles.enter()
                .append("circle")
                .attr("cx", d => xScale(d.x))
                .attr("cy", d => yScale(d.y))
                .attr("r", 4)
                .style("fill", "#3b82f6")
                .style("fill-opacity", 0.1) // Start transparent
                .style("stroke", "#3b82f6")
                .style("stroke-width", 1.5)
                .merge(circles) // Merge enter and update selections
                .transition() // Animate changes
                .duration(500)
                .ease(d3.easeCubicOut)
                .attr("cx", d => xScale(d.x))
                .attr("cy", d => yScale(d.y))
                .style("fill-opacity", 0.6); // Fade in

            circles.exit().remove();
        };
        
        // 5. Responsive Chart Resizing
        const resize = () => {
            // Get container dimensions
            width = container.clientWidth - margin.left - margin.right;
            height = container.clientHeight - margin.top - margin.bottom;

            // Update SVG dimensions
            svg.attr("viewBox", `0 0 ${container.clientWidth} ${container.clientHeight}`);

            // Update scales range
            xScale.range([0, width]);
            yScale.range([height, 0]);

            // Update axes
            xAxisGroup.attr("transform", `translate(0, ${height})`).call(xAxis);
            yAxisGroup.call(yAxis);

            // Update gridlines
            xGridlines
                .call(d3.axisBottom(xScale).ticks(10).tickSize(-height).tickFormat(""))
                .selectAll("line")
                .attr("class", "tick");
            yGridlines
                .call(d3.axisLeft(yScale).ticks(10).tickSize(-width).tickFormat(""))
                .selectAll("line")
                .attr("class", "tick");
            
            // Redraw chart with new dimensions
            updateChart();
        }

        // 6. Event Listeners
        document.getElementById("slope").addEventListener("input", updateChart);
        document.getElementById("width").addEventListener("input", updateChart);
        window.addEventListener('resize', resize);

        // Initial call to draw the chart
        resize();

    </script>
</body>
</html>
